<%
  pageTitle = 'Leads';
  const currentPage = parseInt(filters.page) || 1;
  const totalPages  = Math.ceil(totalLeads / 10) || 1;
%>
<%- include('../partials/header') %>

<% if (followUpsToday > 0) { %>
<div class="followup-banner">
  <div class="followup-banner-icon">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16">
      <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
      <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
    </svg>
  </div>
  <div class="followup-banner-body">
    <strong><%= followUpsToday %> follow-up<%= followUpsToday > 1 ? 's' : '' %> today</strong>
    <span>— Leads highlighted below need attention.</span>
  </div>
</div>
<% } %>

<div class="page-header">
  <div>
    <h2 class="page-title">All Leads</h2>
    <p class="page-subtitle"><%= totalLeads %> lead<%= totalLeads !== 1 ? 's' : '' %> total</p>
  </div>
  <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
    <% if (user.role === 'admin') { %>
    <a href="/leads/export/excel" class="btn btn-outline">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="14" height="14"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      Export Excel
    </a>
    <% } %>
    <a href="/leads/new" class="btn btn-primary">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" width="14" height="14"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Add Lead
    </a>
  </div>
</div>

<!-- Filters -->
<div class="card" style="padding:16px; margin-bottom:16px;">
  <form method="GET" action="/leads" class="filters-bar auto-submit">
    <input type="hidden" name="page" value="1">
    <div class="search-wrap">
      <span class="search-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="14" height="14"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      </span>
      <input type="text" name="search" class="form-control" placeholder="Search name, email, phone…" value="<%= filters.search || '' %>">
    </div>

    <select name="status" class="form-control" style="max-width:150px;">
      <option value="all" <%= !filters.status || filters.status === 'all' ? 'selected' : '' %>>All Status</option>
      <option value="New"         <%= filters.status === 'New'         ? 'selected' : '' %>>New</option>
      <option value="In Progress" <%= filters.status === 'In Progress' ? 'selected' : '' %>>In Progress</option>
      <option value="Closed"      <%= filters.status === 'Closed'      ? 'selected' : '' %>>Closed</option>
    </select>

    <% if (user.role === 'admin' && bdeUsers.length > 0) { %>
    <select name="bde" class="form-control" style="max-width:150px;">
      <option value="">All BDEs</option>
      <% bdeUsers.forEach(bde => { %>
      <option value="<%= bde.id %>" <%= filters.bde == bde.id ? 'selected' : '' %>><%= bde.name %></option>
      <% }) %>
    </select>
    <% } %>

    <button type="submit" class="btn btn-primary btn-sm">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="13" height="13"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
      Filter
    </button>
    <a href="/leads" class="btn btn-ghost btn-sm">Clear</a>
  </form>
</div>

<!-- Leads Table -->
<div class="card" style="padding:0; overflow:hidden;">
  <% if (leads.length === 0) { %>
    <div class="empty-state" style="padding:70px 20px;">
      <div class="empty-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="36" height="36">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
          <circle cx="9" cy="7" r="4"/>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg>
      </div>
      <p>No leads found. Try adjusting your filters.</p>
      <a href="/leads/new" class="btn btn-primary" style="margin-top:12px;">Add First Lead</a>
    </div>
  <% } else { %>
  <div class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th>#</th>
          <th>Lead Details</th>
          <th>Source</th>
          <th>Project / Budget</th>
          <th>Status</th>
          <th>Follow-Up</th>
          <% if (user.role === 'admin') { %><th>BDE</th><% } %>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% leads.forEach((lead, idx) => {
          const isToday = lead.follow_up_date && moment(lead.follow_up_date).format('YYYY-MM-DD') === today;
        %>
        <tr class="<%= isToday ? 'today-follow-up' : '' %>">
          <td class="text-muted text-sm"><%= ((currentPage - 1) * 10) + idx + 1 %></td>
          <td>
            <div class="lead-name"><%= lead.name %></div>
            <% if (lead.email) { %><div class="lead-email"><%= lead.email %></div><% } %>
            <% if (lead.phone) { %><div class="lead-phone"><%= lead.phone %></div><% } %>
          </td>
          <td><span class="source-tag"><%= lead.source %></span></td>
          <td>
            <div style="font-size:13px; color:var(--text);"><%= lead.project_type || '—' %></div>
            <% if (lead.budget) { %>
            <div class="budget-tag">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="11" height="11">
                <line x1="12" y1="1" x2="12" y2="23"/>
                <path d="M17 5H9.5a3.5 3.5 0 1 0 0 7h5a3.5 3.5 0 1 1 0 7H6"/>
              </svg>
              <%= lead.budget %>
            </div>
            <% } %>
          </td>
          <td>
            <span class="badge <%=
              lead.status === 'New' ? 'badge-new' :
              lead.status === 'In Progress' ? 'badge-progress' : 'badge-closed'
            %>"><%= lead.status %></span>
          </td>
          <td>
            <% if (lead.follow_up_date) { %>
              <div class="followup-date <%= isToday ? 'followup-today' : '' %>">
                <% if (isToday) { %>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="12" height="12"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                  Today
                <% } else { %>
                  <%= moment(lead.follow_up_date).format('DD MMM YYYY') %>
                <% } %>
              </div>
            <% } else { %>
              <span style="color:var(--border-dark); font-size:13px;">—</span>
            <% } %>
          </td>
          <% if (user.role === 'admin') { %>
          <td style="font-size:13px; color:var(--text-muted);"><%= lead.bde_name || '—' %></td>
          <% } %>
          <td>
            <div class="action-group">
              <a href="/leads/<%= lead.id %>/edit" class="btn btn-outline btn-sm">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="12" height="12"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                Edit
              </a>
              <% if (user.role === 'admin') { %>
              <form method="POST" action="/leads/<%= lead.id %>/delete" style="display:inline;">
                <button type="submit" class="btn btn-danger btn-sm icon-only" data-confirm="Delete this lead?">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="13" height="13"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
                </button>
              </form>
              <% } %>
            </div>
          </td>
        </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <!-- ── Pagination ─────────────────────────── -->
  <% if (totalPages > 1) { %>
  <div class="pagination-bar">
    <span class="pagination-info">
      Showing <%= ((currentPage - 1) * 10) + 1 %>–<%= Math.min(currentPage * 10, totalLeads) %> of <%= totalLeads %>
    </span>
    <div class="pagination-controls">
      <% if (currentPage > 1) { %>
      <a href="/leads?page=<%= currentPage - 1 %>&search=<%= filters.search || '' %>&status=<%= filters.status || '' %>&bde=<%= filters.bde || '' %>" class="page-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="14" height="14"><polyline points="15 18 9 12 15 6"/></svg>
      </a>
      <% } else { %>
      <span class="page-btn disabled"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="14" height="14"><polyline points="15 18 9 12 15 6"/></svg></span>
      <% } %>

      <% for(let p = Math.max(1, currentPage - 2); p <= Math.min(totalPages, currentPage + 2); p++) { %>
        <a href="/leads?page=<%= p %>&search=<%= filters.search || '' %>&status=<%= filters.status || '' %>&bde=<%= filters.bde || '' %>" class="page-btn <%= p === currentPage ? 'active' : '' %>"><%= p %></a>
      <% } %>

      <% if (currentPage < totalPages) { %>
      <a href="/leads?page=<%= currentPage + 1 %>&search=<%= filters.search || '' %>&status=<%= filters.status || '' %>&bde=<%= filters.bde || '' %>" class="page-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="14" height="14"><polyline points="9 18 15 12 9 6"/></svg>
      </a>
      <% } else { %>
      <span class="page-btn disabled"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="14" height="14"><polyline points="9 18 15 12 9 6"/></svg></span>
      <% } %>
    </div>
  </div>
  <% } %>
  <% } %>
</div>

<%- include('../partials/footer') %>